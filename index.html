<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>히든 엔딩 테스트</title>
<style>
body{
  background:#000;
  color:#eee;
  font-family:"Noto Serif KR",serif;
}
#game{
  max-width:600px;
  margin:40px auto;
  text-align:center;
}
button{
  background:#111;
  border:1px solid #444;
  color:#eee;
  padding:10px 16px;
  cursor:pointer;
}
button:hover{background:#222;}
.dir-pad{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  grid-template-rows:repeat(3,80px);
  gap:10px;
  margin-top:30px;
}
.empty{pointer-events:none;}
</style>
</head>

<body>
<div id="game"></div>

<script>
/* ================= 오디오 ================= */
let ctx;
let buffers = {};

const bgm = new Audio("sound/Symmetry.mp3");
bgm.loop = true;
bgm.volume = 0.7;

const phone = new Audio("sound/phone.mp3");

async function initAudio(){
  if(!ctx){
    ctx = new (window.AudioContext||window.webkitAudioContext)();
    await load("fallenleaves.mp3");
    await load("screm2.mp3");
  }
  if(ctx.state==="suspended") await ctx.resume();
}

async function load(file){
  const res = await fetch("sound/"+file);
  const arr = await res.arrayBuffer();
  buffers[file] = await ctx.decodeAudioData(arr);
}

function playDir(name,dir){
  const src = ctx.createBufferSource();
  const pan = ctx.createStereoPanner();
  const gain = ctx.createGain();

  src.buffer = buffers[name];

  if(dir==="LEFT") pan.pan.value = -1;
  if(dir==="RIGHT") pan.pan.value = 1;
  if(dir==="UP"){ pan.pan.value = 0; gain.gain.value = 0.6; }
  if(dir==="DOWN"){ pan.pan.value = 0; gain.gain.value = 1; }

  src.connect(pan).connect(gain).connect(ctx.destination);
  src.start();
}

/* ================= 상태 ================= */
const game = document.getElementById("game");
let correctDir = "";
let surviveTimer, roundTimer;

/* ================= 렌더 ================= */
function render(html){ game.innerHTML = html; }

/* ================= 시작 ================= */
render(`
  <h2>공중전화</h2>
  <button onclick="call()">112를 누른다</button>
`);

async function call(){
  await initAudio();
  phone.currentTime = 0;
  phone.play();

  setTimeout(()=>{
    phone.pause();
    bgm.play();
    policeCall();
  },3000);
}

function policeCall(){
  render(`
    <p>경찰: 판태현 씨죠?</p>
    <p>태현: 네… 맞는데요.</p>
    <p>경찰: 지금 당장 출동하겠습니다.</p>
    <button onclick="startMinigame()">바위 뒤에 숨는다</button>
  `);
}

/* ================= 미니게임 ================= */
function startMinigame(){
  bgm.volume = 0.25; // ★ 여기서만 BGM 줄임

  surviveTimer = setTimeout(()=>{
    death("사이렌과 함께 나타난 경찰은 처음부터 한패였다.");
  },60000);

  nextRound();
}

function nextRound(){
  clearTimeout(roundTimer);

  const dirs=["UP","DOWN","LEFT","RIGHT"];
  correctDir = dirs[Math.floor(Math.random()*4)];

  playDir("fallenleaves.mp3",correctDir);

  if(Math.random()<0.6){
    setTimeout(()=>{
      playDir("screm2.mp3",dirs[Math.floor(Math.random()*4)]);
    },500);
  }

  render(`
    <h2>숨는다</h2>
    <p>소리가 나는 방향을 클릭하라</p>
    <div class="dir-pad">
      <div class="empty"></div>
      <button onclick="check('UP')">↑</button>
      <div class="empty"></div>

      <button onclick="check('LEFT')">←</button>
      <div class="empty"></div>
      <button onclick="check('RIGHT')">→</button>

      <div class="empty"></div>
      <button onclick="check('DOWN')">↓</button>
      <div class="empty"></div>
    </div>
  `);

  roundTimer = setTimeout(()=>{
    death("낙엽이 바로 등 뒤에서 밟혔다.");
  },5000);
}

function check(dir){
  clearTimeout(roundTimer);
  if(dir!==correctDir){
    death("비명을 따라 움직인 순간 숨결이 겹쳤다.");
    return;
  }
  setTimeout(nextRound,700);
}

/* ================= 사망 ================= */
function death(text){
  clearTimeout(surviveTimer);
  bgm.pause();
  bgm.volume = 0.7;
  render(`<h2>사망</h2><p>${text}</p>`);
}
</script>
</body>
</html>
