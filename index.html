<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>탈출 게임 - 최종본</title>
<style>
body {
  background:#000;
  color:#eee;
  font-family: 'Malgun Gothic', monospace;
  margin:0;
}
#game {
  max-width:800px;
  margin:auto;
  padding:20px;
}
#story {
  white-space: pre-line;
  margin-bottom:20px;
  border-bottom:1px solid #444;
  padding-bottom:20px;
}
#actions button, .keypad button {
  margin:5px;
  padding:10px 15px;
  background:#111;
  color:#eee;
  border:1px solid #555;
  cursor:pointer;
}
#actions button:hover, .keypad button:hover {
  background:#333;
}
.keypad {
  display:grid;
  grid-template-columns: repeat(3, 60px);
  gap:5px;
  margin-top:10px;
}
#inputDisplay {
  margin-top:10px;
  font-size:18px;
}
</style>
</head>
<body>

<div id="game">
  <div id="story"></div>
  <div id="actions"></div>
</div>

<script>
let state = {
  location: "room",
  pin: false,
  basementKey: false,
  frontKey: false,
  escapeKey: false,
  caughtCount: 0,
  input: ""
};

function show(text, actions=[]) {
  document.getElementById("story").innerText = text;
  const a = document.getElementById("actions");
  a.innerHTML = "";
  actions.forEach(act=>{
    const b = document.createElement("button");
    b.innerText = act.text;
    b.onclick = act.fn;
    a.appendChild(b);
  });
}

function caught() {
  state.caughtCount++;
  if(state.caughtCount >= 3) {
    show(
`문이 닫히는 소리와 함께
시야가 완전히 어두워진다.

이번에는 다시 깨어나지 못했다.`
    );
  } else {
    state.location = "basement";
    show(
`누군가 뒤에서 붙잡는다.
눈을 뜨자 지하실이다.

이번이 ${state.caughtCount}번째다.`,
    [{text:"주위를 살핀다", fn: basement}]
    );
  }
}

/* 시작 */
show(
`태현은 공원에서 강아지와 산책 중이었다.
갑작스러운 냄새와 함께 의식이 끊겼다.

눈을 뜨자 낯선 방.`,
[{text:"방을 살핀다", fn: room}]
);

function room() {
  show(
`작은 방.
서랍과 문이 보인다.`,
[
  {text:"서랍을 뒤진다", fn: drawer},
  {text:"문을 확인한다", fn: door}
]
);
}

function drawer() {
  state.pin = true;
  show(
`서랍 안에서 핀셋을 발견했다.

메모가 있다.
"잡히지 마라.
두 번까지는 기회다."
"지하실이 핵심이다."`,
[{text:"뒤로", fn: room}]
);
}

function door() {
  if(state.pin) {
    show(
`핀셋으로 문을 열 수 있을 것 같다.`,
[
  {text:"문을 연다", fn: study},
  {text:"뒤로", fn: room}
]
);
  } else {
    caught();
  }
}

function study() {
  state.location = "study";
  show(
`서재.
문 하나가 더 있다.`,
[
  {text:"주방으로 간다", fn: kitchen},
  {text:"뒤로", fn: room}
]
);
}

function kitchen() {
  show(
`주방에서 발소리가 들린다.`,
[
  {text:"화장실로 도망친다", fn: bathroom},
  {text:"숨는다", fn: caught}
]
);
}

function bathroom() {
  show(
`화장실.
잠시 숨을 수 있다.`,
[
  {text:"거실로 이동", fn: living}
]
);
}

function living() {
  show(
`거실.
현관과 지하실 문이 있다.`,
[
  {text:"지하실로 간다", fn: basementDoor},
  {text:"현관으로 간다", fn: frontDoor}
]
);
}

function basementDoor() {
  if(state.basementKey) {
    basement();
  } else {
    show(
`지하실 문은 잠겨 있다.
열쇠가 필요하다.`,
[{text:"뒤로", fn: living}]
);
  }
}

function basement() {
  show(
`지하실.
금고가 있다.`,
[
  {text:"금고를 연다", fn: safe},
  {text:"탈출 통로 확인", fn: basementEscape}
]
);
}

function safe() {
  state.frontKey = true;
  state.escapeKey = true;
  show(
`금고 안에서
현관 열쇠와 비상 열쇠를 얻었다.`,
[{text:"뒤로", fn: basement}]
);
}

function basementEscape() {
  if(state.escapeKey) {
    show(
`좁은 통로 끝에서 밖의 공기가 느껴진다.
탈출 성공.`,
[{text:"공중전화로 이동", fn: phoneChoice}]
);
  } else {
    show(`열쇠가 없다.`,[{text:"뒤로", fn: basement}]);
  }
}

function frontDoor() {
  if(!state.frontKey) {
    show(`열쇠가 없다.`,[{text:"뒤로", fn: living}]);
    return;
  }
  numberUI("현관 비밀번호를 입력하라", "0421", phoneChoice);
}

function numberUI(text, code, successFn) {
  state.input = "";
  const game = document.getElementById("game");
  game.innerHTML = `
    <div id="story">${text}</div>
    <div id="inputDisplay"></div>
    <div class="keypad"></div>
  `;
  const pad = document.querySelector(".keypad");
  for(let i=1;i<=9;i++) addKey(i);
  addKey(0);
  function addKey(n){
    const b=document.createElement("button");
    b.innerText=n;
    b.onclick=()=>{
      state.input+=n;
      document.getElementById("inputDisplay").innerText=state.input;
      if(state.input===code) successFn();
    };
    pad.appendChild(b);
  }
}

function phoneChoice() {
  show(
`밖이다.
공중전화가 보인다.`,
[
  {text:"전화를 건다", fn: phoneUI},
  {text:"그냥 떠난다", fn: ()=>show("그는 아무 말 없이 사라졌다.")}
]
);
}

function phoneUI() {
  numberUI("번호를 입력하라", "112", ()=>show("연결되었다. 도움은 올 것이다."));
}
</script>

</body>
</html>
