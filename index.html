<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>탈출</title>
<style>
body{
  background:#000;
  color:#eee;
  font-family:"Noto Serif KR",serif;
  line-height:1.7;
}
#game{
  max-width:820px;
  margin:40px auto;
  padding:20px;
}
.part{
  border-top:2px solid #333;
  margin-top:30px;
  padding-top:20px;
}
button{
  width:100%;
  padding:12px;
  margin:10px 0;
  background:#111;
  color:#eee;
  border:1px solid #444;
  cursor:pointer;
}
button:hover{background:#222;}
h2{margin-top:0;}
</style>
</head>
<body>
<div id="game"></div>

<script>
const game=document.getElementById("game");

const state={
  tweezers:false,
  basementKey:false,
  safeKey:false,
  frontKey:false,
  caught:0,
  history:[]
};

/* ================= 공통 ================= */
function render(text,options=[],back=false){
  game.innerHTML=text;

  if(back && state.history.length){
    const b=document.createElement("button");
    b.innerText="뒤로 가기";
    b.onclick=()=>state.history.pop()();
    game.appendChild(b);
  }

  options.forEach(o=>{
    const btn=document.createElement("button");
    btn.innerText=o.text;
    btn.onclick=()=>{
      state.history.push(()=>render(text,options,back));
      randomEncounter(o.action);
    };
    game.appendChild(btn);
  });
}

/* ================= 랜덤 납치범 ================= */
function randomEncounter(next){
  // 지하실 제외 이동 시 30% 확률
  if(Math.random() < 0.3){
    state.caught++;
    if(state.caught === 1){
      render(`
      <div class="part">
      <h2>발각</h2>
      <p>
      뒤에서 숨소리가 느껴진다.<br>
      손에는 칼이 들려 있다.<br>
      정신을 잃는다…
      </p>
      </div>
      `,[{text:"눈을 뜬다",action:basementCaptured}]);
    }else{
      death();
    }
  }else{
    next();
  }
}

/* ================= PART 0 ================= */
function part0(){
render(`
<div class="part">
<h2>PART 0 : 새벽의 공원</h2>
<p>
사람 없는 새벽, 강아지와 산책 중이었다.<br>
퍽—<br>
기억이 끊겼다.
</p>
</div>
`,[{text:"눈을 뜬다",action:room}]);
}

/* ================= PART 1 ================= */
function room(){
render(`
<div class="part">
<h2>PART 1 : 방</h2>
<p>신문지로 막힌 창문. 잠긴 문.</p>
</div>
`,[
{text:"방을 살핀다",action:searchRoom},
{text:"가만히 있는다",action:wait}
]);
}

function searchRoom(){
render(`
<p>
장기 매매 기록.<br>
이유는 명확하다.
</p>
`,[
{text:"서랍",action:getTweezers}
],true);
}

function getTweezers(){
state.tweezers=true;
render(`<p>핀셋을 얻었다.</p>`,[
{text:"문으로 간다",action:door}
]);
}

function door(){
render(`<p>핀셋으로 문을 열었다.</p>`,[
{text:"밖으로",action:secondFloor}
]);
}

function wait(){
state.caught++;
if(state.caught===1){
basementCaptured();
}else{
death();
}
}

/* ================= PART 2 ================= */
function secondFloor(){
render(`
<div class="part">
<h2>2층</h2>
<p>조용하다.</p>
</div>
`,[
{text:"서재",action:library},
{text:"계단",action:kitchen}
]);
}

function library(){
render(`
<div class="part">
<h2>서재</h2>
<p>해부학 책이 가득하다.</p>
</div>
`,[
{text:"메모",action:memo},
{text:"서랍",action:getBasementKey},
{text:"나간다",action:freeMove}
],true);
}

function memo(){
render(`<p>탈출은 현관과 지하실.</p>`,[
{text:"뒤로",action:library}
]);
}

function getBasementKey(){
state.basementKey=true;
render(`<p>지하실 열쇠를 얻었다.</p>`,[
{text:"나간다",action:freeMove}
]);
}

/* ================= 지하실 강제 이동 ================= */
function basementCaptured(){
render(`
<div class="part">
<h2>지하실</h2>
<p>이번엔 도끼다.</p>
</div>
`,[
{text:"탈출을 시도한다",action:freeMove}
]);
}

/* ================= 자유 이동 ================= */
function freeMove(){
render(`
<div class="part">
<h2>집 안</h2>
<p>어디로 갈까?</p>
</div>
`,[
{text:"2층",action:secondFloor},
{text:"서재",action:library},
{text:"화장실",action:bathroom},
{text:"거실",action:livingroom}
]);
}

/* ================= 주방 ================= */
function kitchen(){
render(`
<div class="part">
<h2>주방</h2>
<p>뒤에서 소리가 난다.</p>
</div>
`,[
{text:"화장실로 도망",action:bathroom}
]);
}

/* ================= 화장실 ================= */
function bathroom(){
render(`
<div class="part">
<h2>화장실</h2>
<p>숨을 곳을 고른다.</p>
</div>
`,[
{text:"문 뒤",action:livingroom},
{text:"욕조",action:freeMove}
]);
}

/* ================= 거실 ================= */
function livingroom(){
render(`
<div class="part">
<h2>거실</h2>
<p>중앙 공간이다.</p>
</div>
`,[
{text:"TV",action:tv},
{text:"서랍",action:getSafeKey},
{text:"지하실",action:basement}
]);
}

function tv(){
render(`<p>TV에서 3849가 반복된다.</p>`,[
{text:"뒤로",action:livingroom}
]);
}

function getSafeKey(){
state.safeKey=true;
render(`<p>금고 열쇠를 얻었다.</p>`,[
{text:"뒤로",action:livingroom}
]);
}

/* ================= 지하실 ================= */
function basement(){
if(!state.basementKey){
render(`<p>지하실은 잠겨 있다.</p>`,[
{text:"뒤로",action:livingroom}
]);
return;
}
render(`
<div class="part">
<h2>지하실</h2>
<p>금고와 판자가 있다.</p>
</div>
`,[
{text:"금고",action:safe},
{text:"판자를 조사한다",action:basementEscape},
{text:"나간다",action:freeMove}
]);
}

function safe(){
if(!state.safeKey){
render(`<p>금고는 잠겨 있다.</p>`,[
{text:"뒤로",action:basement}
]);
return;
}
state.frontKey=true;
render(`<p>현관 열쇠를 얻었다.</p>`,[
{text:"뒤로",action:basement}
]);
}

function basementEscape(){
if(state.caught>0 || !state.frontKey){
render(`<p>조건이 맞지 않는다.</p>`,[
{text:"뒤로",action:basement}
]);
return;
}
render(`
<h2>탈출</h2>
<p>
도끼로 판자를 부쉈다.<br>
차가운 공기.<br>
살아남았다.
</p>
`);
}

/* ================= 사망 ================= */
function death(){
render(`<h2>사망</h2><p>두 번째 실수는 끝이다.</p>`);
}

part0();
</script>
</body>
</html>
