<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>탈출</title>
<style>
body{
background:#000;
color:#eee;
font-family:"Noto Serif KR",serif;
line-height:1.7;
}
#game{max-width:820px;margin:40px auto;padding:20px;}
.part{border-top:2px solid #333;margin-top:30px;padding-top:20px;}
button{
width:100%;
padding:12px;
margin:8px 0;
background:#111;
color:#eee;
border:1px solid #444;
cursor:pointer;
}
button:hover{background:#222;}
.keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
.display{
background:#111;
padding:12px;
margin-bottom:10px;
text-align:center;
letter-spacing:6px;
font-size:20px;
}
.memo{color:#aaa;font-style:italic;}
h2{margin-top:0;}
</style>
</head>

<body>
<div id="game"></div>

<script>
/* ================== 사운드 ================== */
const bgm=new Audio("./sound/TheDread.mp3");
const chaseBgm=new Audio("./sound/Anxiety.mp3");

bgm.loop=true;
chaseBgm.loop=true;
bgm.volume=.7;
chaseBgm.volume=.6;

let audioUnlocked=false;
function unlockAudio(){
if(audioUnlocked) return;
bgm.play().catch(()=>{});
audioUnlocked=true;
}
function playChase(){
bgm.pause();
chaseBgm.currentTime=0;
chaseBgm.play().catch(()=>{});
}
function stopChase(){
chaseBgm.pause();
bgm.play().catch(()=>{});
}

/* ================== 상태 ================== */
const game=document.getElementById("game");
const state={
tweezers:false,
basementKey:false,
safeKey:false,
frontKey:false,
deathReason:"",
returnFunc:null
};

/* ================== 렌더 ================== */
function render(html,options=[]){
game.innerHTML=html;
options.forEach(o=>{
const btn=document.createElement("button");
btn.innerText=o.text;
btn.onclick=()=>{
unlockAudio();
o.action();
};
game.appendChild(btn);
});
}

/* ================== 도망 시스템 ================== */
let escapeTimer=null;

function startEscape(returnFunc){
state.returnFunc=returnFunc;
playChase();

render(`
<h2>기척</h2>
<p>뒤에서 급히 다가오는 발소리.</p>
<p>숨을 곳을 선택해야 한다.</p>
`,[
{text:"거실로 도망간다",action:()=>resolveEscape()},
{text:"화장실로 숨는다",action:()=>resolveEscape()},
{text:"지하실로 내려간다",action:()=>resolveEscape()}
]);

escapeTimer=setTimeout(()=>{
state.deathReason="결정을 내리지 못했다.";
death();
},5000);
}

function resolveEscape(){
clearTimeout(escapeTimer);
if(Math.random()<0.6){
stopChase();
render(`<p>발소리가 점점 멀어진다…</p>`,[
{text:"계속",action:state.returnFunc}
]);
}else{
state.deathReason="숨은 곳이 들켰다.";
death();
}
}

/* ================== 랜덤 납치 ================== */
function randomHunter(next){
if(Math.random()<0.28){
startEscape(next);
}else next();
}

/* ================== PART 0 ================== */
function part0(){
render(`
<div class="part">
<h2>PART 0 : 새벽의 공원</h2>
<p>퍽.<br>뒤통수에 둔탁한 충격.</p>
</div>
`,[{text:"눈을 뜬다",action:room}]);
}

/* ================== 방 ================== */
function room(){
stopChase();
render(`
<div class="part">
<h2>방</h2>
<p>신문지로 막힌 창문. 문은 잠겨 있다.</p>
</div>
`,[
{text:"문을 확인한다",action:door},
{text:"방 조사",action:searchRoom},
{text:"가만히 있는다",action:()=>startEscape(room)}
]);
}

function searchRoom(){
render(`<p>서랍과 침대가 보인다.</p>`,[
{text:"서랍을 연다",action:()=>{
state.tweezers=true;
render(`<p>핀셋을 발견했다.</p>`,[
{text:"돌아간다",action:room}
]);
}},
{text:"침대 밑을 본다",action:()=>randomHunter(room)}
]);
}

function door(){
if(!state.tweezers){
render(`<p>문이 잠겨 있다. 손으로는 열리지 않는다.</p>`,[
{text:"돌아간다",action:room}
]);
return;
}
render(`<p>핀셋으로 잠금을 풀었다.</p>`,[
{text:"문을 연다",action:secondFloor}
]);
}

/* ================== 2층 ================== */
function secondFloor(){
stopChase();
render(`
<div class="part">
<h2>2층</h2>
<p>집 안이 비정상적으로 조용하다.</p>
</div>
`,[
{text:"서재로 간다",action:()=>randomHunter(library)},
{text:"계단을 내려간다",action:kitchen}
]);
}

function library(){
render(`
<div class="part">
<h2>서재</h2>
<p>해부학 책과 사진들이 흩어져 있다.</p>
</div>
`,[
{text:"메모를 본다",action:()=>render(
`<p class="memo">TV의 숫자를 기억해라.</p>`,
[{text:"뒤로",action:library}]
)},
{text:"서랍을 연다",action:()=>{
state.basementKey=true;
render(`<p>지하실 열쇠를 얻었다.</p>`,[
{text:"뒤로",action:library}
]);
}},
{text:"나간다",action:()=>randomHunter(secondFloor)}
]);
}

/* ================== 주방 ================== */
function kitchen(){
render(`
<div class="part">
<h2>주방</h2>
<p>냄새가 심하다.</p>
</div>
`,[
{text:"거실로 이동",action:()=>randomHunter(livingroom)}
]);
}

/* ================== 거실 ================== */
function livingroom(){
stopChase();
render(`
<div class="part">
<h2>거실</h2>
</div>
`,[
{text:"TV를 본다",action:()=>render(
`<p>TV 화면에 3849가 반복된다.</p>`,
[{text:"뒤로",action:livingroom}]
)},
{text:"서랍을 연다",action:()=>{
state.safeKey=true;
render(`<p>금고 열쇠를 얻었다.</p>`,[
{text:"뒤로",action:livingroom}
]);
}},
{text:"지하실로 간다",action:basement},
{text:"현관으로 간다",action:frontDoor}
]);
}

/* ================== 지하실 ================== */
function basement(){
if(!state.basementKey){
render(`<p>문이 잠겨 있다.</p>`,[
{text:"뒤로",action:livingroom}
]);
return;
}
render(`
<div class="part">
<h2>지하실</h2>
<p>금고가 보인다.</p>
</div>
`,[
{text:"금고를 연다",action:()=>{
if(!state.safeKey){
render(`<p>금고가 잠겨 있다.</p>`,[
{text:"뒤로",action:basement}
]);
return;
}
state.frontKey=true;
render(`<p>현관 열쇠를 얻었다.</p>`,[
{text:"뒤로",action:basement}
]);
}},
{text:"나간다",action:()=>randomHunter(livingroom)}
]);
}

/* ================== 현관 ================== */
function frontDoor(){
render(`
<h2>현관</h2>
<p>밖으로 나갈 수 있을 것 같다.</p>
`,[
{text:"문을 연다",action:()=>{
if(!state.frontKey){
state.deathReason="문이 열리지 않는다.";
death();
}else{
render(`<h2>탈출 성공</h2><p>문 밖으로 뛰쳐나왔다.</p>`);
}
}}
]);
}

/* ================== 사망 ================== */
function death(){
render(`<h2>사망</h2><p>${state.deathReason}</p>`);
}

part0();
</script>
</body>
</html>
