<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>탈출</title>
<style>
body{
background:#000;
color:#eee;
font-family:"Noto Serif KR",serif;
line-height:1.7;
}
#game{max-width:820px;margin:40px auto;padding:20px;}
.part{border-top:2px solid #333;margin-top:30px;padding-top:20px;}
button{
width:100%;padding:12px;margin:8px 0;
background:#111;color:#eee;border:1px solid #444;cursor:pointer;
}
button:hover{background:#222;}
.keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
.display{
background:#111;
padding:12px;
margin-bottom:10px;
text-align:center;
letter-spacing:6px;
font-size:20px;
}
.memo{color:#aaa;font-style:italic;}
h2{margin-top:0;}
.bar{width:100%;height:20px;background:#222;margin:15px 0;}
.fill{height:100%;background:#aaa;width:100%;transition:width .2s linear;}
</style>
</head>

<body>
<div id="game"></div>

<script>
/* ================== 사운드 ================== */
const bgm=new Audio("./sound/TheDread.mp3");
const chaseBgm=new Audio("./sound/Anxiety.mp3");
const hiddenBgm=new Audio("./sound/Symmetry.mp3");
const phoneConnectSfx=new Audio("./sound/connect.mp3");
const leavesSfx=new Audio("./sound/fallenleaves.mp3");
const screamSfx=new Audio("./sound/screm2.mp3");

bgm.loop=chaseBgm.loop=hiddenBgm.loop=true;
bgm.volume=.7; chaseBgm.volume=.6; hiddenBgm.volume=.7;

let audioUnlocked=false;
function unlockAudio(){
if(audioUnlocked) return;
bgm.play().catch(()=>{});
audioUnlocked=true;
}
function playChase(){bgm.pause(); chaseBgm.currentTime=0; chaseBgm.play().catch(()=>{});}
function stopChase(){chaseBgm.pause(); bgm.play().catch(()=>{});}
function playHidden(){
bgm.pause(); chaseBgm.pause();
hiddenBgm.currentTime=0;
hiddenBgm.play().catch(()=>{});
}

/* ================== 상태 ================== */
const game=document.getElementById("game");
const state={
tweezers:false,basementKey:false,safeKey:false,frontKey:false,
caught:0,deathReason:"",input:"",
returnFunc:null
};

/* ================== 렌더 ================== */
function render(html,options=[]){
game.innerHTML=html;
options.forEach(o=>{
const btn=document.createElement("button");
btn.innerText=o.text;
btn.onclick=()=>{
unlockAudio();
o.action();
};
game.appendChild(btn);
});
}

/* ================== 도망 시스템 ================== */
let escapeTimer=null;

function startEscape(returnFunc){
state.returnFunc=returnFunc;
playChase();
render(`
<h2>기척</h2>
<p>등 뒤에서 발소리가 들린다.</p>
<p>숨을 곳을 선택하라.</p>
`,[
{text:"거실",action:()=>escapePlace("거실")},
{text:"화장실",action:()=>escapePlace("화장실")},
{text:"지하실",action:()=>escapePlace("지하실")}
]);

escapeTimer=setTimeout(()=>{
state.deathReason="망설이다 붙잡혔다.";
death();
},5000);
}

function escapePlace(place){
clearTimeout(escapeTimer);
let options=[];
if(place==="화장실"){
options=["문 뒤","욕조"];
}
if(place==="거실"){
options=["소파 뒤","TV 뒤"];
}
if(place==="지하실"){
options=["계단 밑","기둥 뒤"];
}
render(`<h2>${place}</h2><p>어디에 숨을까?</p>`,
options.map(o=>({text:o,action:()=>resolveEscape()}))
);

escapeTimer=setTimeout(()=>{
state.deathReason="숨기 전에 잡혔다.";
death();
},5000);
}

function resolveEscape(){
clearTimeout(escapeTimer);
if(Math.random()<0.5){
stopChase();
render(`<p>발소리가 멀어진다…</p>`,[
{text:"계속",action:state.returnFunc}
]);
}else{
state.deathReason="숨은 곳이 들켰다.";
death();
}
}

/* ================== 랜덤 납치 (수정됨) ================== */
function randomHunter(next){
if(Math.random()<0.28){
startEscape(next);
}else next();
}

/* ================== PART 0 ================== */
function part0(){
render(`
<div class="part">
<h2>PART 0 : 새벽의 공원</h2>
<p>퍽.<br>뒤통수에 둔탁한 충격.</p>
</div>
`,[{text:"눈을 뜬다",action:room}]);
}

/* ================== 방 ================== */
function room(){
stopChase();
render(`
<div class="part">
<h2>방</h2>
<p>신문지로 막힌 창문. 잠긴 문.</p>
</div>
`,[
{text:"문",action:door},
{text:"방 조사",action:searchRoom},
{text:"가만히",action:wait}
]);
}

function searchRoom(){
render(`<p>장기 매매 기록… 이름: 판태현</p>`,[
{text:"서랍",action:()=>{state.tweezers=true; render(`<p>핀셋을 얻었다.</p>`,[{text:"문",action:door}]);}},
{text:"침대 밑",action:()=>randomHunter(room)}
]);
}

function door(){
if(!state.tweezers){
render(`<p>문이 잠겨 있다.</p>`,[{text:"뒤로",action:room}]);
return;
}
render(`<p>문이 열린다.</p>`,[{text:"밖으로",action:secondFloor}]);
}

function wait(){
state.deathReason="아무것도 하지 않는 선택.";
death();
}

/* ================== 이하 기존 코드 그대로 ================== */
/* 2층 ~ 히든엔딩 전부 변경 없음 */

part0();
</script>
</body>
</html>
