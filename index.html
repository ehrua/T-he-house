<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>탈출</title>
<style>
body{
background:#000;
color:#eee;
font-family:"Noto Serif KR",serif;
line-height:1.7;
}
#game{max-width:820px;margin:40px auto;padding:20px;}
.part{border-top:2px solid #333;margin-top:30px;padding-top:20px;}
button{
width:100%;padding:12px;margin:8px 0;
background:#111;color:#eee;border:1px solid #444;cursor:pointer;
}
button:hover{background:#222;}
.keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
.display{
background:#111;
padding:12px;
margin-bottom:10px;
text-align:center;
letter-spacing:6px;
font-size:20px;
}
.memo{color:#aaa;font-style:italic;}
h2{margin-top:0;}
.bar{width:100%;height:20px;background:#222;margin:15px 0;}
.fill{height:100%;background:#aaa;width:100%;transition:width .2s linear;}
</style>
</head>

<body>
<div id="game"></div>

<script>
/* ================== 사운드 ================== */
const bgm=new Audio("./sound/TheDread.mp3");
const chaseBgm=new Audio("./sound/Anxiety.mp3");
const hiddenBgm=new Audio("./sound/Symmetry.mp3");
const phoneConnectSfx=new Audio("./sound/connect.mp3");
const leavesSfx=new Audio("./sound/fallenleaves.mp3");
const screamSfx=new Audio("./sound/screm2.mp3");

bgm.loop=chaseBgm.loop=hiddenBgm.loop=true;
bgm.volume=.7; chaseBgm.volume=.6; hiddenBgm.volume=.7;

let audioUnlocked=false;
function unlockAudio(){
if(audioUnlocked) return;
bgm.play().catch(()=>{});
audioUnlocked=true;
}
function playChase(){
bgm.pause();
chaseBgm.currentTime=0;
chaseBgm.play().catch(()=>{});
}
function stopChase(){
chaseBgm.pause();
bgm.play().catch(()=>{});
}
function playHidden(){
bgm.pause(); chaseBgm.pause();
hiddenBgm.currentTime=0;
hiddenBgm.play().catch(()=>{});
}

/* ================== 상태 ================== */
const game=document.getElementById("game");
const state={
tweezers:false,basementKey:false,safeKey:false,frontKey:false,
deathReason:"",input:"",
returnFunc:null
};

/* ================== 렌더 ================== */
function render(html,options=[]){
game.innerHTML=html;
options.forEach(o=>{
const btn=document.createElement("button");
btn.innerText=o.text;
btn.onclick=()=>{
unlockAudio();
o.action();
};
game.appendChild(btn);
});
}

/* ================== 추격 시스템 ================== */
let chaseTimer=null;

function startChase(returnFunc){
state.returnFunc=returnFunc;
playChase();

render(`
<h2>추격</h2>
<p>등 뒤에서 급히 다가오는 기척.</p>
<p>지금 선택하지 않으면 잡힌다.</p>
`,[
{text:"도망친다",action:()=>resolveChase()},
{text:"숨는다",action:()=>resolveChase()}
]);

chaseTimer=setTimeout(()=>{
state.deathReason="결정을 내리지 못했다.";
death();
},3000);
}

function resolveChase(){
clearTimeout(chaseTimer);
if(Math.random()<0.6){
stopChase();
render(`<p>발소리가 멀어진다…</p>`,[
{text:"계속",action:state.returnFunc}
]);
}else{
state.deathReason="붙잡혔다.";
death();
}
}

/* ================== 랜덤 납치 → 추격 ================== */
function randomHunter(next){
if(Math.random()<0.28){
startChase(next);
}else next();
}

/* ================== PART 0 ================== */
function part0(){
render(`
<div class="part">
<h2>PART 0 : 새벽의 공원</h2>
<p>퍽.<br>뒤통수에 둔탁한 충격.</p>
</div>
`,[{text:"눈을 뜬다",action:room}]);
}

/* ================== 방 ================== */
function room(){
stopChase();
render(`
<div class="part">
<h2>방</h2>
<p>신문지로 막힌 창문. 잠긴 문.</p>
</div>
`,[
{text:"문",action:door},
{text:"방 조사",action:searchRoom},
{text:"가만히",action:()=>startChase(room)}
]);
}

function searchRoom(){
render(`<p>장기 매매 기록… 이름: 판태현</p>`,[
{text:"서랍",action:()=>{state.tweezers=true; render(`<p>핀셋을 얻었다.</p>`,[{text:"문",action:door}]);}},
{text:"침대 밑",action:()=>randomHunter(room)}
]);
}

function door(){
if(!state.tweezers){
render(`<p>문이 잠겨 있다.</p>`,[{text:"뒤로",action:room}]);
return;
}
render(`<p>문이 열린다.</p>`,[{text:"밖으로",action:secondFloor}]);
}

/* ================== 2층 ================== */
function secondFloor(){
stopChase();
render(`<div class="part"><h2>2층</h2></div>`,[
{text:"서재",action:()=>randomHunter(library)},
{text:"계단",action:kitchen}
]);
}

function library(){
render(`
<div class="part"><h2>서재</h2><p>사진과 해부학 책.</p></div>
`,[
{text:"메모",action:()=>render(`<p class="memo">TV의 숫자를 기억해라. 그는 기회를 준다...</p>`,[{text:"뒤로",action:library}])},
{text:"서랍",action:()=>{state.basementKey=true; render(`<p>지하실 열쇠 획득.</p>`,[{text:"뒤로",action:library}]);}},
{text:"나간다",action:()=>randomHunter(secondFloor)}
]);
}

/* ================== 주방 ================== */
function kitchen(){
render(`<div class="part"><h2>주방</h2></div>`,[
{text:"거실",action:()=>randomHunter(livingroom)}
]);
}

/* ================== 거실 ================== */
function livingroom(){
stopChase();
render(`<div class="part"><h2>거실</h2></div>`,[
{text:"TV",action:()=>render(`<p>TV에 3849가 반복된다.</p>`,[{text:"뒤로",action:livingroom}])},
{text:"서랍",action:()=>{state.safeKey=true; render(`<p>금고 열쇠 획득.</p>`,[{text:"뒤로",action:livingroom}]);}},
{text:"지하실",action:basement},
{text:"현관",action:frontDoor}
]);
}

/* ================== 지하실 ================== */
function basement(){
if(!state.basementKey){
render(`<p>잠겨 있다.</p>`,[{text:"뒤로",action:livingroom}]);
return;
}
render(`<div class="part"><h2>지하실</h2></div>`,[
{text:"금고",action:()=>{
if(!state.safeKey){render(`<p>잠겨 있다.</p>`,[{text:"뒤로",action:basement}]);return;}
state.frontKey=true;
render(`<p>현관 열쇠다.</p>`,[{text:"뒤로",action:basement}]);
}},
{text:"나간다",action:()=>randomHunter(livingroom)}
]);
}

/* ================== 현관 ================== */
function frontDoor(){
state.input="";
drawKeypad("현관 도어락",checkDoor);
}

function drawKeypad(title,callback){
render(`<h2>${title}</h2><div class="display">${state.input}</div><div class="keypad" id="pad"></div>`);
const pad=document.getElementById("pad");
[1,2,3,4,5,6,7,8,9,0].forEach(n=>{
const b=document.createElement("button");
b.innerText=n;
b.onclick=()=>{state.input+=n; drawKeypad(title,callback);};
pad.appendChild(b);
});
const ok=document.createElement("button");
ok.innerText="확인";
ok.onclick=callback;
pad.appendChild(ok);
}

function checkDoor(){
if(!state.frontKey){state.deathReason="문이 열리지 않는다."; death(); return;}
if(state.input==="3849") outside();
else{state.deathReason="경보음이 울렸다."; playChase(); death();}
}

/* ================== 바깥 ================== */
function outside(){
stopChase();
render(`
<div class="part">
<h2>밖</h2>
<p>골목 끝, 공중전화.</p>
</div>
`,[{text:"공중전화",action:payphone}]);
}

/* ================== 공중전화 ================== */
function payphone(){
state.input="";
drawKeypad("공중전화",callPhone);
}

function callPhone(){
phoneConnectSfx.play();
setTimeout(()=>{
if(state.input==="112") startMiniGame();
else if(state.input==="3849"){playHidden(); render(`<h2>히든 엔딩 : 거래</h2>`);}
else{state.deathReason="신호가 끊겼다."; death();}
},2000);
}

/* ================== 숨 참기 ================== */
let holding=false,breath=100,survived=0,leavesTimer,screamTimer;
function startMiniGame(){
playHidden();
render(`
<h2>숨을 참아라</h2>
<p>소리가 나면 끝이다.</p>
<div class="bar"><div class="fill" id="breathBar"></div></div>
<button id="holdBtn">숨 참기</button>
`);
const btn=document.getElementById("holdBtn");
btn.onmousedown=()=>holding=true;
btn.onmouseup=btn.onmouseleave=()=>holding=false;

leavesTimer=setInterval(()=>{
if(leavesSfx.paused){
leavesSfx.volume=Math.random()<.2?1:.6;
leavesSfx.currentTime=0; leavesSfx.play();
}},7000+Math.random()*5000);

screamTimer=setInterval(()=>{
screamSfx.currentTime=0; screamSfx.play();
},20000);

const loop=setInterval(()=>{
if(holding){breath-=2; survived++;}
else breath+=1;
breath=Math.max(0,Math.min(100,breath));
document.getElementById("breathBar").style.width=breath+"%";

if(breath<=0){clearAll(loop); render(`<h2>사망</h2><p>숨이 새어 나갔다.</p>`);}
if(survived>=60){clearAll(loop); render(`<h2>히든 엔딩 : 사이렌</h2><p>멀리서 사이렌.</p>`);}
},200);
}

function clearAll(loop){
clearInterval(loop);
clearInterval(leavesTimer);
clearInterval(screamTimer);
}

/* ================== 사망 ================== */
function death(){
render(`<h2>사망</h2><p>${state.deathReason}</p>`);
}

part0();
</script>
</body>
</html>
