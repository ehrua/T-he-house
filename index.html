<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>íƒˆì¶œ</title>
<style>
body{
background:#000;
color:#eee;
font-family:"Noto Serif KR",serif;
line-height:1.7;
}
#game{max-width:820px;margin:40px auto;padding:20px;}
.part{border-top:2px solid #333;margin-top:30px;padding-top:20px;}
button{
width:100%;padding:12px;margin:8px 0;
background:#111;color:#eee;border:1px solid #444;cursor:pointer;
}
button:hover{background:#222;}
.keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
.display{
background:#111;
padding:12px;
margin-bottom:10px;
text-align:center;
letter-spacing:6px;
font-size:20px;
}
.memo{color:#aaa;font-style:italic;}
h2{margin-top:0;}
.bar{width:100%;height:20px;background:#222;margin:15px 0;}
.fill{height:100%;background:#aaa;width:100%;transition:width .2s linear;}
</style>
</head>

<body>
<div id="game"></div>

<script>
/* ================== ì‚¬ìš´ë“œ ================== */
const bgm=new Audio("./sound/TheDread.mp3");
const chaseBgm=new Audio("./sound/Anxiety.mp3");
const hiddenBgm=new Audio("./sound/Symmetry.mp3");
const phoneKeySfx=new Audio("./sound/phone.mp3");
const phoneConnectSfx=new Audio("./sound/connect.mp3");
const leavesSfx=new Audio("./sound/fallenleaves.mp3");
const screamSfx=new Audio("./sound/screm2.mp3");

bgm.loop=chaseBgm.loop=hiddenBgm.loop=true;
bgm.volume=.7; chaseBgm.volume=.6; hiddenBgm.volume=.7;

let audioUnlocked=false;
function unlockAudio(){
if(audioUnlocked) return;
bgm.play().catch(()=>{});
audioUnlocked=true;
}
function playChase(){bgm.pause(); chaseBgm.currentTime=0; chaseBgm.play().catch(()=>{});}
function stopChase(){chaseBgm.pause(); bgm.play().catch(()=>{});}
function playHidden(){
bgm.pause(); chaseBgm.pause();
hiddenBgm.currentTime=0;
hiddenBgm.play().catch(()=>{});
}

/* ================== ìƒíƒœ ================== */
const game=document.getElementById("game");
const state={
tweezers:false,basementKey:false,safeKey:false,frontKey:false,
caught:0,deathReason:"",input:"",history:[],hunterTimer:null
};

/* ================== ë Œë” ================== */
function render(html,options=[],back=false,noHunter=false){ // ğŸ”§ CHANGED
clearTimeout(state.hunterTimer);
game.innerHTML=html;

if(!noHunter && Math.random()<0.28){ // ğŸ”§ CHANGED (ë¹ˆë„ ì¦ê°€)
state.hunterTimer=setTimeout(()=>{
triggerHideSequence();
},10000+Math.random()*8000);
}

if(back&&state.history.length){
const b=document.createElement("button");
b.innerText="ë’¤ë¡œ ê°€ê¸°";
b.onclick=()=>state.history.pop()();
game.appendChild(b);
}

options.forEach(o=>{
const btn=document.createElement("button");
btn.innerText=o.text;
btn.onclick=()=>{
unlockAudio();
state.history.push(()=>render(html,options,back,noHunter));
o.action();
};
game.appendChild(btn);
});
}

/* ================== ìˆ¨ê¸° ì‹œí€€ìŠ¤ ================== */
function triggerHideSequence(){
playChase();
let timer;
render(`
<div class="part">
<h2>ê¸°ì²™</h2>
<p>ë°œì†Œë¦¬ê°€ ê°€ê¹Œì›Œì§„ë‹¤.</p>
<p><b>5ì´ˆ ì•ˆì— ìˆ¨ì„ ê³³ì„ ì„ íƒí•˜ë¼.</b></p>
</div>
`,[
{text:"í™”ì¥ì‹¤",action:bathroomHide},
{text:"ê±°ì‹¤",action:livingroomHide},
{text:"ì§€í•˜ì‹¤",action:basementHide}
],false,true);

timer=setTimeout(()=>{
state.deathReason="ë¨¸ë­‡ê±°ë¦¬ëŠ” ìˆœê°„, ì†ì´ ë‹¿ì•˜ë‹¤.";
death();
},5000);
}

function bathroomHide(){
render(`
<h2>í™”ì¥ì‹¤</h2>
<p>ì•…ì·¨ì™€ í”¼ ëƒ„ìƒˆ.</p>
`,[
{text:"ë¬¸ ë’¤",action:()=>resolveHide(0.5,"ë¬¸ ë’¤ì—ì„œ ìˆ¨ì„ ì£½ì˜€ë‹¤.")},
{text:"ìš•ì¡°",action:()=>resolveHide(0.25,"í”¼ë¡œ ê°€ë“ ì°¬ ìš•ì¡° ì†ìœ¼ë¡œ ëª¸ì„ ë°€ì–´ ë„£ì—ˆë‹¤.")}
],false,true);
}

function livingroomHide(){
resolveHide(0.4,"ê°€êµ¬ ë’¤ì—ì„œ ìˆ¨ì„ ë©ˆì·„ë‹¤.");
}

function basementHide(){
resolveHide(0.6,"ì§€í•˜ì˜ ì–´ë‘ ì´ ë„ˆë¥¼ ì‚¼ì¼°ë‹¤.");
}

function resolveHide(chance,successText){
if(Math.random()<chance){
stopChase();
render(`<p>${successText}</p>`,[{text:"ì¡°ì‹¬íˆ ì´ë™í•œë‹¤",action:secondFloor}],false,true);
}else{
state.deathReason="ìˆ¨ì†Œë¦¬ê°€ ë“¤ë ¸ë‹¤.";
death();
}
}

/* ================== PART 0 ================== */
function part0(){
render(`
<div class="part">
<h2>PART 0 : ìƒˆë²½ì˜ ê³µì›</h2>
<p>í½.<br>ë’¤í†µìˆ˜ì— ë‘”íƒí•œ ì¶©ê²©.</p>
</div>
`,[{text:"ëˆˆì„ ëœ¬ë‹¤",action:room}]);
}

/* ================== ë°© ================== */
function room(){
stopChase();
render(`
<div class="part">
<h2>ë°©</h2>
<p>ì‹ ë¬¸ì§€ë¡œ ë§‰íŒ ì°½ë¬¸. ì ê¸´ ë¬¸.</p>
</div>
`,[
{text:"ë¬¸",action:door},
{text:"ë°© ì¡°ì‚¬",action:searchRoom},
{text:"ê°€ë§Œíˆ",action:wait}
]);
}

/* ì´í•˜ ê¸°ì¡´ ì½”ë“œ ì „ë¶€ ë™ì¼ (ìƒëµ ì—†ìŒ) */
/* â€¦ */
/* ================== í˜„ê´€ ================== */
function frontDoor(){
state.input="";
drawKeypad("í˜„ê´€ ë„ì–´ë½",checkDoor);
}

function drawKeypad(title,callback){
render(`<h2>${title}</h2><div class="display">${state.input}</div><div class="keypad" id="pad"></div>`,[],true,true); // ğŸ”§ CHANGED
const pad=document.getElementById("pad");
[1,2,3,4,5,6,7,8,9,0].forEach(n=>{
const b=document.createElement("button");
b.innerText=n;
b.onclick=()=>{state.input+=n; drawKeypad(title,callback);};
pad.appendChild(b);
});
const ok=document.createElement("button");
ok.innerText="í™•ì¸";
ok.onclick=callback;
pad.appendChild(ok);
}

/* ================== ì‚¬ë§ ================== */
function death(){
clearTimeout(state.hunterTimer);
render(`<h2>ì‚¬ë§</h2><p>${state.deathReason}</p>`,[],false,true);
}

part0();
</script>
</body>
</html>
