<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>탈출</title>
<style>
body {
  background:#000;
  color:#eee;
  font-family: "Noto Serif KR", serif;
  line-height:1.7;
}
#game {
  max-width:800px;
  margin:40px auto;
  padding:20px;
}
.part {
  border-top:2px solid #333;
  margin-top:30px;
  padding-top:20px;
}
button {
  display:block;
  margin:10px 0;
  padding:10px;
  width:100%;
  background:#111;
  color:#eee;
  border:1px solid #444;
  cursor:pointer;
}
button:hover {
  background:#222;
}
.keypad {
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:10px;
}
</style>
</head>
<body>

<div id="game"></div>

<script>
const game = document.getElementById("game");

const state = {
  tweezers:false,
  basementKey:false,
  frontKey:false,
  caughtCount:0,
  history:[]
};

function render(text, options=[], backAllowed=false) {
  game.innerHTML = text;

  if(backAllowed && state.history.length>0){
    const back = document.createElement("button");
    back.innerText = "뒤로 가기";
    back.onclick = ()=>state.history.pop()();
    game.appendChild(back);
  }

  options.forEach(o=>{
    const btn = document.createElement("button");
    btn.innerText = o.text;
    btn.onclick = ()=>{
      state.history.push(()=>render(text,options,backAllowed));
      o.action();
    };
    game.appendChild(btn);
  });
}

/* =================
   잡힘 처리
================= */
function caught(){
  state.caughtCount++;
  if(state.caughtCount >= 3){
    render(`<h3>문이 닫히고 소리가 멀어진다.</h3><p>사망</p>`);
  } else {
    basementForced();
  }
}

/* =================
   PART 0
================= */
function part0(){
render(`
<div class="part">
<h2>PART 0 : 새벽</h2>
<p>
공원에서 강아지와 산책 중이었다.<br>
퍽.<br>
기억이 끊겼다.
</p>
</div>
`,[{text:"눈을 뜬다",action:part1}]);
}

/* =================
   PART 1 : 방
================= */
function part1(){
render(`
<div class="part">
<h2>PART 1 : 방</h2>
<p>창문은 모두 막혀 있다.</p>
</div>
`,[
{text:"문",action:doorLocked},
{text:"방을 살핀다",action:searchRoom},
{text:"대기한다",action:caught}
]);
}

function doorLocked(){
render(`<p>문이 잠겨 있다.</p>`,[
{text:"서랍",action:getTweezers}
],true);
}

function getTweezers(){
state.tweezers=true;
render(`<p>핀셋을 발견했다.</p>`,[
{text:"문으로",action:useTweezers}
]);
}

function searchRoom(){
render(`<p>장기 기록 문서다. 장기 매매 목적의 납치.</p>`,[
{text:"뒤로",action:part1}
]);
}

/* =================
   PART 2
================= */
function useTweezers(){
render(`
<div class="part">
<h2>PART 2 : 2층</h2>
</div>
`,[
{text:"서재",action:library},
{text:"계단",action:downstairs}
]);
}

function library(){
render(`
<div class="part">
<h2>서재</h2>
</div>
`,[
{text:"책",action:escapeMemo},
{text:"서랍",action:getBasementKey},
{text:"나간다",action:caught}
],true);
}

function escapeMemo(){
render(`<p>현관과 지하실. 지하실이 핵심.</p>`,[
{text:"뒤로",action:library}
]);
}

function getBasementKey(){
state.basementKey=true;
render(`<p>지하실 열쇠 획득.</p>`,[
{text:"뒤로",action:library}
]);
}

/* =================
   PART 3
================= */
function downstairs(){
render(`
<div class="part">
<h2>1층 주방</h2>
</div>
`,[
{text:"숨는다",action:caught},
{text:"도망",action:bathroom}
]);
}

function bathroom(){
render(`<p>화장실이다.</p>`,[
{text:"거실",action:livingroom},
{text:"다시 숨는다",action:caught}
]);
}

/* =================
   PART 4 : 거실
================= */
function livingroom(){
render(`
<div class="part">
<h2>거실</h2>
</div>
`,[
{text:"TV",action:tvHint},
{text:"지하실",action:basement},
{text:"현관",action:frontDoor}
]);
}

function tvHint(){
render(`<p>TV: 정답은 3849</p>`,[
{text:"뒤로",action:livingroom}
]);
}

/* =================
   지하실
================= */
function basement(){
if(!state.basementKey){
render(`<p>지하실 문이 잠겨 있다.</p>`,[
{text:"뒤로",action:livingroom}
]);
return;
}
render(`
<div class="part">
<h2>지하실</h2>
<p>금고가 있다.</p>
</div>
`,[
{text:"금고",action:safe},
{text:"탈출 통로",action:basementEscape}
]);
}

function basementForced(){
render(`
<div class="part">
<h2>지하실</h2>
<p>끌려왔다.</p>
</div>
`,[
{text:"금고",action:safe}
]);
}

function safe(){
state.frontKey=true;
render(`<p>금고 안에서 현관 열쇠.</p>`,[
{text:"뒤로",action:basement}
]);
}

function basementEscape(){
render(`<h2>숲</h2><p>공중전화가 있다.</p>`,[
{text:"다가간다",action:phoneChoice}
]);
}

/* =================
   현관 번호 UI
================= */
function frontDoor(){
if(!state.frontKey){
render(`<p>열쇠가 없다.</p>`,[{text:"뒤로",action:livingroom}]);
return;
}
numberUI("현관 번호 입력","3849",basementEscape);
}

/* =================
   전화 UI
================= */
function phoneChoice(){
render(`<p>전화를 걸까?</p>`,[
{text:"건다",action:phoneUI},
{text:"떠난다",action:()=>render("<h2>탈출</h2>")}
]);
}

function numberUI(title,code,success){
let input="";
game.innerHTML=`<h3>${title}</h3><p id="disp"></p><div class="keypad"></div>`;
const pad=document.querySelector(".keypad");
[1,2,3,4,5,6,7,8,9,0].forEach(n=>{
const b=document.createElement("button");
b.innerText=n;
b.onclick=()=>{
input+=n;
document.getElementById("disp").innerText=input;
if(input===code) success();
};
pad.appendChild(b);
});
}

function phoneUI(){
numberUI("번호 입력","112",()=>render("<p>연결된다…</p>"));
}

part0();
</script>
</body>
</html>
