<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>탈출</title>
<style>
body{
background:#000;
color:#eee;
font-family:"Noto Serif KR",serif;
line-height:1.7;
}
#game{max-width:820px;margin:40px auto;padding:20px;}
.part{border-top:2px solid #333;margin-top:30px;padding-top:20px;}
button{
width:100%;padding:12px;margin:8px 0;
background:#111;color:#eee;border:1px solid #444;cursor:pointer;
}
button:hover{background:#222;}
.keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
.display{
background:#111;
padding:12px;
margin-bottom:10px;
text-align:center;
letter-spacing:6px;
font-size:20px;
}
.memo{color:#aaa;font-style:italic;}
h2{margin-top:0;}
.bar{width:100%;height:20px;background:#222;margin:15px 0;}
.fill{height:100%;background:#aaa;width:100%;transition:width .2s linear;}
</style>
</head>

<body>
<div id="game"></div>

<script>
/* ================== 사운드 ================== */
const bgm=new Audio("./sound/TheDread.mp3");
const chaseBgm=new Audio("./sound/Anxiety.mp3");
bgm.loop=chaseBgm.loop=true;
bgm.volume=.7; chaseBgm.volume=.6;

/* ================== 상태 ================== */
const game=document.getElementById("game");
const state={
tweezers:false,basementKey:false,safeKey:false,frontKey:false,
deathReason:"",input:"",hunterTimer:null,escapeTimer:null
};

/* ================== 렌더 ================== */
function render(html,options=[]){
clearTimeout(state.hunterTimer);
clearTimeout(state.escapeTimer);
game.innerHTML=html;
options.forEach(o=>{
const btn=document.createElement("button");
btn.innerText=o.text;
btn.onclick=o.action;
game.appendChild(btn);
});
}

/* ================== 납치 이벤트 ================== */
function hunterEncounter(success){
chaseBgm.currentTime=0;
chaseBgm.play().catch(()=>{});

render(`
<div class="part">
<p>바로 뒤에서 발소리가 멈췄다.</p>
<p>숨을 곳을 골라야 한다.</p>
</div>
`,[
{text:"화장실",action:()=>bathroom(success)},
{text:"거실",action:()=>simpleHide(success,"거실")},
{text:"지하실",action:()=>simpleHide(success,"지하실")}
]);

state.escapeTimer=setTimeout(()=>{
death("망설이는 사이, 손이 닿았다.");
},5000);
}

function simpleHide(success,place){
clearTimeout(state.escapeTimer);
Math.random()<0.6 ? success() : death(place+"에서 발견되었다.");
}

function bathroom(success){
render(`
<div class="part">
<h2>화장실</h2>
<p>피와 썩은 냄새.</p>
</div>
`,[
{text:"문 뒤",action:()=>{
clearTimeout(state.escapeTimer);
Math.random()<0.6 ? success() : death("문이 열렸다.");
}},
{text:"욕조",action:()=>{
clearTimeout(state.escapeTimer);
Math.random()<0.4 ? success() : death("시체 더미가 움직였다.");
}}
]);
}

/* ================== 랜덤 납치 ================== */
function randomHunter(next){
if(Math.random()<0.32){
hunterEncounter(next);
}else next();
}

/* ================== 시작 ================== */
function part0(){
bgm.play().catch(()=>{});
render(`
<div class="part">
<h2>PART 0 : 새벽의 공원</h2>
<p>퍽.<br>뒤통수에 둔탁한 충격.</p>
</div>
`,[{text:"눈을 뜬다",action:room}]);
}

/* ================== 방 ================== */
function room(){
render(`
<div class="part">
<h2>방</h2>
<p>신문지로 막힌 창문. 잠긴 문.</p>
</div>
`,[
{text:"문",action:door},
{text:"방 조사",action:()=>randomHunter(room)}
]);
}

function door(){
if(!state.tweezers){
render(`<p>문이 잠겨 있다.</p>`,[{text:"뒤로",action:room}]);
return;
}
render(`<p>문이 열린다.</p>`,[{text:"밖으로",action:secondFloor}]);
}

/* ================== 2층 ================== */
function secondFloor(){
render(`<div class="part"><h2>2층</h2></div>`,[
{text:"서재",action:()=>randomHunter(library)},
{text:"계단",action:()=>randomHunter(livingroom)}
]);
}

function library(){
render(`
<div class="part"><h2>서재</h2></div>
`,[
{text:"서랍",action:()=>{state.basementKey=true; render(`<p>지하실 열쇠 획득.</p>`,[{text:"뒤로",action:library}]);}},
{text:"나간다",action:()=>randomHunter(secondFloor)}
]);
}

/* ================== 거실 ================== */
function livingroom(){
render(`<div class="part"><h2>거실</h2></div>`,[
{text:"TV",action:()=>render(`<p>TV에 3849가 반복된다.</p>`,[{text:"뒤로",action:livingroom}])},
{text:"서랍",action:()=>{state.safeKey=true; render(`<p>금고 열쇠 획득.</p>`,[{text:"뒤로",action:livingroom}]);}},
{text:"지하실",action:basement},
{text:"현관",action:frontDoor}
]);
}

/* ================== 지하실 ================== */
function basement(){
if(!state.basementKey){
render(`<p>잠겨 있다.</p>`,[{text:"뒤로",action:livingroom}]);
return;
}
render(`<div class="part"><h2>지하실</h2></div>`,[
{text:"금고",action:()=>{
if(!state.safeKey){render(`<p>잠겨 있다.</p>`,[{text:"뒤로",action:basement}]);return;}
state.frontKey=true;
render(`<p>현관 열쇠다.</p>`,[{text:"뒤로",action:basement}]);
}},
{text:"나간다",action:()=>randomHunter(livingroom)}
]);
}

/* ================== 현관 ================== */
function frontDoor(){
state.input="";
drawKeypad();
}

function drawKeypad(){
render(`
<h2>현관 도어락</h2>
<div class="display">${state.input}</div>
<div class="keypad" id="pad"></div>
`,[]);
const pad=document.getElementById("pad");
[1,2,3,4,5,6,7,8,9,0].forEach(n=>{
const b=document.createElement("button");
b.innerText=n;
b.onclick=()=>{state.input+=n; drawKeypad();};
pad.appendChild(b);
});
const ok=document.createElement("button");
ok.innerText="확인";
ok.onclick=checkDoor;
pad.appendChild(ok);
}

function checkDoor(){
if(!state.frontKey){death("문이 열리지 않는다.");return;}
if(state.input==="3849"){outside();}
else{death("경보음이 울렸다.");}
}

/* ================== 바깥 ================== */
function outside(){
render(`
<div class="part">
<h2>밖</h2>
<p>골목 끝에 공중전화.</p>
</div>
`,[{text:"공중전화",action:()=>render(`<h2>엔딩으로 이어집니다</h2>`)}]);
}

/* ================== 사망 ================== */
function death(reason){
render(`<h2>사망</h2><p>${reason}</p>`);
}

part0();
</script>
</body>
</html>
