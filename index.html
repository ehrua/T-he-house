<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>히든 엔딩 테스트</title>
<style>
body{
    background:#000;
    color:#eee;
    font-family:"Noto Serif KR",serif;
}
#game{
    max-width:700px;
    margin:40px auto;
}
button{
    width:100%;
    padding:14px;
    margin-top:10px;
    background:#111;
    color:#eee;
    border:1px solid #444;
    cursor:pointer;
}
button:active{
    background:#333;
}
.bar{
    width:100%;
    height:20px;
    background:#222;
    margin-top:15px;
}
.fill{
    height:100%;
    background:#aaa;
    width:100%;
    transition:width 0.2s linear;
}
</style>
</head>

<body>
<div id="game"></div>

<script>
/* ===== 사운드 ===== */
const bgm = new Audio("./sound/TheDread.mp3");
const phoneSfx = new Audio("./sound/phone.mp3");
const leavesSfx = new Audio("./sound/fallenleaves.mp3");
const screamSfx = new Audio("./sound/screm2.mp3");

bgm.loop = true;
bgm.volume = 0.2;

/* ===== 상태 ===== */
let holding = false;
let breath = 100;
let survived = 0;
let leavesTimer = null;
let screamTimer = null;

/* ===== 렌더 ===== */
const game = document.getElementById("game");
function render(html){
    game.innerHTML = html;
}

/* ===== 시작 ===== */
render(`
<h2>공중전화</h2>
<p>수화기를 들었다.</p>
<button id="call112">112를 누른다</button>
`);

document.getElementById("call112").onclick = () => {
    bgm.play().catch(()=>{});
    phoneSfx.currentTime = 0;
    phoneSfx.play();
    setTimeout(policeCall,3000);
};

/* ===== 통화 ===== */
function policeCall(){
    phoneSfx.pause();
    phoneSfx.currentTime = 0;

    render(`
<p>뚜…</p>
<p>경찰: 판태현 씨죠?</p>
<p>태현: 네? 제 이름을 어떻게…</p>
<p>경찰: 지금 당장 출동하겠습니다.</p>
<button id="hide">전화를 끊고 숨는다</button>
`);
    document.getElementById("hide").onclick = startMiniGame;
}

/* ===== 미니게임 ===== */
function startMiniGame(){
    breath = 100;
    survived = 0;

    render(`
<h2>숨을 참아라</h2>
<p>소리가 나면 들킬 것이다.</p>

<div class="bar">
    <div class="fill" id="breathBar"></div>
</div>

<button id="holdBtn">숨 참기</button>
`);

    const btn = document.getElementById("holdBtn");

    btn.onmousedown = ()=>holding=true;
    btn.onmouseup = ()=>holding=false;
    btn.onmouseleave = ()=>holding=false;
    btn.ontouchstart = (e)=>{ e.preventDefault(); holding=true; };
    btn.ontouchend = ()=>holding=false;

    /* === 낙엽 소리 (빈도 감소 + 겹침 방지) === */
    function playLeaves(){
        if(!leavesSfx.paused) return;

        const loud = Math.random() < 0.2;
        leavesSfx.volume = loud ? 1.0 : 0.6;

        leavesSfx.currentTime = 0;
        leavesSfx.play();
    }

    leavesTimer = setInterval(()=>{
        playLeaves();
    }, 6000 + Math.random()*4000); // ✅ 6~10초

    /* === 비명은 그대로 === */
    screamTimer = setInterval(()=>{
        screamSfx.currentTime = 0;
        screamSfx.play();
    }, 20000);

    gameLoop();
}

/* ===== 게임 루프 ===== */
function gameLoop(){
    const bar = document.getElementById("breathBar");

    const loop = setInterval(()=>{
        if(holding){
            breath -= 2;
            survived += 1;
        }else{
            breath += 1;
        }

        breath = Math.max(0,Math.min(100,breath));
        bar.style.width = breath + "%";

        if(breath <= 0){
            clearAll(loop);
            render("<h2>사망</h2><p>숨을 참지 못했다.</p>");
        }

        if(survived >= 60){
            clearAll(loop);
            render("<h2>히든 엔딩</h2><p>멀리서 사이렌이 들린다.</p>");
        }
    },200);
}

/* ===== 정리 ===== */
function clearAll(loop){
    clearInterval(loop);
    clearInterval(leavesTimer);
    clearInterval(screamTimer);
}
</script>
</body>
</html>
