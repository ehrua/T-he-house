<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>히든 엔딩 테스트</title>
<style>
body{
  background:#000;
  color:#eee;
  font-family:"Noto Serif KR",serif;
  line-height:1.7;
}
#game{
  max-width:720px;
  margin:40px auto;
  padding:20px;
}
button{
  width:100%;
  padding:14px;
  margin:10px 0;
  background:#111;
  color:#eee;
  border:1px solid #444;
  cursor:pointer;
}
button:hover{background:#222;}
.part{border-top:2px solid #333;padding-top:20px;}
.memo{color:#aaa;font-style:italic;}
</style>
</head>

<body>
<div id="game"></div>

<script>
/* ================= 사운드 ================= */
const hiddenBgm = new Audio("./sound/Symmetry.mp3");
const phoneSfx = new Audio("./sound/phone.mp3");
const leaves = new Audio("./sound/fallenleaves.mp3");
const scream = new Audio("./sound/screm2.mp3");

hiddenBgm.loop = true;
hiddenBgm.volume = 0.7;
phoneSfx.volume = 0.9;
leaves.volume = 0.8;
scream.volume = 0.7;

/* ================= 상태 ================= */
const game = document.getElementById("game");
let correctDir = "";
let surviveStart = 0;
let surviveTimer = null;
let roundTimer = null;

/* ================= 렌더 ================= */
function render(html, options=[]){
  game.innerHTML = html;
  options.forEach(o=>{
    const b = document.createElement("button");
    b.innerText = o.text;
    b.onclick = o.action;
    game.appendChild(b);
  });
}

/* ================= 시작 ================= */
render(`
  <div class="part">
    <h2>공중전화</h2>
    <p>수화기를 들었다.</p>
  </div>
`,[
  {text:"112를 누른다", action:call112},
  {text:"3849를 누른다", action:call112}
]);

/* ================= 통화 ================= */
function call112(){
  phoneSfx.currentTime = 0;
  phoneSfx.play();

  setTimeout(()=>{
    phoneSfx.pause();
    phoneSfx.currentTime = 0;
    fakePoliceCall();
  },3000);
}

function fakePoliceCall(){
  hiddenBgm.play();

  render(`
    <div class="part">
      <p>뚜…</p>
      <p><b>경찰:</b> 판태현 씨죠?</p>
      <p><b>태현:</b> 네? 네… 맞는데요.</p>
      <p><b>경찰:</b> 지금 당장 출동하겠습니다.</p>
      <p class="memo">전화가 끊기지 않는다.</p>
    </div>
  `,[
    {text:"바위 뒤에 숨는다", action:startMinigame}
  ]);
}

/* ================= 미니게임 ================= */
function startMinigame(){
  surviveStart = Date.now();

  surviveTimer = setTimeout(()=>{
    endDeath("사이렌과 함께 도착한 경찰은 처음부터 이 집의 일부였다.");
  },60000);

  nextRound();
}

function nextRound(){
  clearTimeout(roundTimer);

  const dirs = ["북","남","동","서"];
  correctDir = dirs[Math.floor(Math.random()*4)];

  // 진짜 낙엽 소리
  leaves.currentTime = 0;
  leaves.play();

  // 가짜 비명 (확률)
  if(Math.random() < 0.6){
    setTimeout(()=>{
      scream.currentTime = 0;
      scream.play();
    },300 + Math.random()*700);
  }

  render(`
    <div class="part">
      <h2>숨는다</h2>
      <p>소리가 나는 방향을 선택하라.</p>
      <p class="memo">비명은 거짓이다.</p>
    </div>
  `,[
    {text:"북", action:()=>check("북")},
    {text:"남", action:()=>check("남")},
    {text:"동", action:()=>check("동")},
    {text:"서", action:()=>check("서")}
  ]);

  roundTimer = setTimeout(()=>{
    endDeath("망설이는 순간, 낙엽이 바로 뒤에서 밟혔다.");
  },5000);
}

function check(dir){
  clearTimeout(roundTimer);

  if(dir !== correctDir){
    endDeath("비명을 따라 움직인 순간 숨결이 목덜미에 닿았다.");
    return;
  }

  if(Date.now() - surviveStart < 60000){
    setTimeout(nextRound,600);
  }
}

/* ================= 사망 ================= */
function endDeath(text){
  clearTimeout(surviveTimer);
  clearTimeout(roundTimer);
  hiddenBgm.pause();

  render(`
    <div class="part">
      <h2>사망</h2>
      <p>${text}</p>
    </div>
  `);
}
</script>
</body>
</html>
