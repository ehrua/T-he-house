<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>히든 엔딩 테스트</title>
<style>
body{
  background:#000;
  color:#eee;
  font-family:"Noto Serif KR",serif;
}
#game{
  max-width:600px;
  margin:40px auto;
  text-align:center;
}
.part{border-top:2px solid #333;padding-top:20px;}

.dir-pad{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  grid-template-rows:repeat(3,80px);
  gap:10px;
  margin-top:30px;
}
.dir-pad button{
  background:#111;
  border:1px solid #444;
  color:#eee;
  font-size:18px;
  cursor:pointer;
}
.dir-pad button:hover{background:#222;}
.empty{pointer-events:none;}
.memo{color:#aaa;font-style:italic;}
</style>
</head>

<body>
<div id="game"></div>

<script>
/* ================= 사운드 ================= */
const ctx = new (window.AudioContext || window.webkitAudioContext)();

const hiddenBgm = new Audio("./sound/Symmetry.mp3");
const phoneSfx = new Audio("./sound/phone.mp3");
const leaves = new Audio("./sound/fallenleaves.mp3");
const scream = new Audio("./sound/screm2.mp3");

hiddenBgm.loop = true;
hiddenBgm.volume = 0.7;
phoneSfx.volume = 0.9;

/* ================= 상태 ================= */
const game = document.getElementById("game");
let correctDir = "";
let surviveStart = 0;
let surviveTimer = null;
let roundTimer = null;

/* ================= 유틸 ================= */
function playDirectional(audio, dir){
  const src = ctx.createMediaElementSource(audio);
  const pan = ctx.createStereoPanner();
  const gain = ctx.createGain();

  if(dir === "LEFT") pan.pan.value = -1;
  if(dir === "RIGHT") pan.pan.value = 1;
  if(dir === "UP"){ pan.pan.value = 0; gain.gain.value = 0.7; }
  if(dir === "DOWN"){ pan.pan.value = 0; gain.gain.value = 1; }

  src.connect(pan).connect(gain).connect(ctx.destination);
  audio.currentTime = 0;
  audio.play();
}

/* ================= 렌더 ================= */
function render(html){
  game.innerHTML = html;
}

/* ================= 시작 ================= */
render(`
  <div class="part">
    <h2>공중전화</h2>
    <button onclick="call()">112를 누른다</button>
  </div>
`);

function call(){
  phoneSfx.play();
  setTimeout(()=>{
    phoneSfx.pause();
    hiddenBgm.play();
    fakePolice();
  },3000);
}

function fakePolice(){
  render(`
    <div class="part">
      <p>경찰: 판태현 씨죠?</p>
      <p>태현: 네… 맞는데요.</p>
      <p>경찰: 지금 당장 출동하겠습니다.</p>
      <p class="memo">전화는 끊기지 않는다.</p>
      <button onclick="startMinigame()">바위 뒤에 숨는다</button>
    </div>
  `);
}

/* ================= 미니게임 ================= */
function startMinigame(){
  surviveStart = Date.now();
  surviveTimer = setTimeout(()=>{
    death("사이렌과 함께 도착한 경찰은 처음부터 한패였다.");
  },60000);
  nextRound();
}

function nextRound(){
  clearTimeout(roundTimer);

  const dirs = ["UP","DOWN","LEFT","RIGHT"];
  correctDir = dirs[Math.floor(Math.random()*4)];

  playDirectional(leaves, correctDir);

  if(Math.random()<0.6){
    setTimeout(()=>{
      playDirectional(scream, dirs[Math.floor(Math.random()*4)]);
    },400);
  }

  render(`
    <div class="part">
      <h2>숨는다</h2>
      <p>소리가 나는 방향을 선택하라</p>
      <div class="dir-pad">
        <div class="empty"></div>
        <button onclick="check('UP')">↑</button>
        <div class="empty"></div>

        <button onclick="check('LEFT')">←</button>
        <div class="empty"></div>
        <button onclick="check('RIGHT')">→</button>

        <div class="empty"></div>
        <button onclick="check('DOWN')">↓</button>
        <div class="empty"></div>
      </div>
    </div>
  `);

  roundTimer = setTimeout(()=>{
    death("낙엽이 바로 등 뒤에서 밟혔다.");
  },5000);
}

function check(dir){
  clearTimeout(roundTimer);

  if(dir !== correctDir){
    death("비명을 따라 움직인 순간 숨결이 겹쳤다.");
    return;
  }

  if(Date.now() - surviveStart < 60000){
    setTimeout(nextRound,600);
  }
}

/* ================= 사망 ================= */
function death(text){
  clearTimeout(surviveTimer);
  hiddenBgm.pause();
  render(`
    <div class="part">
      <h2>사망</h2>
      <p>${text}</p>
    </div>
  `);
}
</script>
</body>
</html>
