<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>히든 엔딩</title>
<style>
body{
    background:#000;
    color:#eee;
    font-family:"Noto Serif KR",serif;
}
#game{
    max-width:700px;
    margin:40px auto;
}
button{
    width:100%;
    padding:14px;
    margin-top:10px;
    background:#111;
    color:#eee;
    border:1px solid #444;
    cursor:pointer;
}
button:active{background:#333;}
.keypad{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:8px;
}
.display{
    background:#111;
    padding:12px;
    margin-bottom:10px;
    text-align:center;
    letter-spacing:6px;
    font-size:20px;
}
.bar{
    width:100%;
    height:20px;
    background:#222;
    margin-top:15px;
}
.fill{
    height:100%;
    background:#aaa;
    width:100%;
    transition:width .2s linear;
}
p{line-height:1.7;}
</style>
</head>

<body>
<div id="game"></div>

<script>
/* ===== 사운드 ===== */
const phoneSfx = new Audio("./sound/phone.mp3");
const leavesSfx = new Audio("./sound/fallenleaves.mp3");

/* ===== 상태 ===== */
const game = document.getElementById("game");
let input="";
let holding=false;
let breath=100;
let survived=0;
let leavesInterval=null;
let leavesActive=false;

/* ===== 렌더 ===== */
function render(html){ game.innerHTML=html; }

/* ===== 공중전화 ===== */
function payphone(){
    input="";
    render(`
        <h2>공중전화</h2>
        <div class="display">${input}</div>
        <div class="keypad" id="pad"></div>
    `);

    const pad=document.getElementById("pad");

    [1,2,3,4,5,6,7,8,9,0].forEach(n=>{
        const b=document.createElement("button");
        b.innerText=n;
        b.onclick=()=>{ input+=n; payphone(); };
        pad.appendChild(b);
    });

    const ok=document.createElement("button");
    ok.innerText="확인";
    ok.onclick=confirmCall;
    pad.appendChild(ok);
}

payphone();

/* ===== 112 확인 ===== */
function confirmCall(){
    if(input!=="112"){
        render("<h2>…</h2><p>연결되지 않는다.</p>");
        return;
    }

    phoneSfx.currentTime=0;
    phoneSfx.play();

    render(`
        <h2>통화 연결 중</h2>
        <p>뚜…</p>
    `);

    // 3초 후 통화 연결 → 효과음 종료
    setTimeout(()=>{
        phoneSfx.pause();
        phoneSfx.currentTime=0;
        policeCall();
    },3000);
}

/* ===== 경찰 통화 ===== */
function policeCall(){
    const lines=[
        "경찰: 태현씨죠?",
        "태현: 네? 어떻게 제 이름을…",
        "경찰?: 지금 사건 장소 특정했고 지금 당장 출발하겠습니다.",
        "경찰?: 10분 정도 예상되네요.",
        "경찰?: 공중전화 부스 앞쪽에 있는 돌 뒤에 숨어 계세요.",
        "경찰?: 아, 그리고… 낙엽 밟는 소리 조심하세요.",
        "태현: 네? …",
        "뚝—"
    ];

    game.innerHTML="<h2>통화 중</h2>";
    let i=0;

    const talk=setInterval(()=>{
        const p=document.createElement("p");
        p.innerText=lines[i];
        game.appendChild(p);
        i++;

        if(i>=lines.length){
            clearInterval(talk);
            const btn=document.createElement("button");
            btn.innerText="돌 뒤에 숨는다";
            btn.onclick=startMiniGame;
            game.appendChild(btn);
        }
    },1200);
}

/* ===== 숨참기 미니게임 ===== */
function startMiniGame(){
    breath=100;
    survived=0;

    render(`
        <h2>돌 뒤</h2>
        <p>소리가 나면 들킨다.</p>
        <div class="bar"><div class="fill" id="breathBar"></div></div>
        <button id="holdBtn">숨 참기</button>
    `);

    const btn=document.getElementById("holdBtn");
    btn.onmousedown=()=>holding=true;
    btn.onmouseup=btn.onmouseleave=()=>holding=false;

    // 낙엽 소리: 10초마다, 3~5초
    leavesInterval=setInterval(()=>{
        if(leavesActive) return;
        leavesActive=true;

        leavesSfx.currentTime=0;
        leavesSfx.play();

        setTimeout(()=>{
            leavesSfx.pause();
            leavesSfx.currentTime=0;
            leavesActive=false;
        },3000+Math.random()*2000);
    },10000);

    gameLoop();
}

/* ===== 게임 루프 ===== */
function gameLoop(){
    const bar=document.getElementById("breathBar");

    const loop=setInterval(()=>{
        if(holding){
            breath-=2;
            survived++;
        }else{
            breath+=1;
        }

        breath=Math.max(0,Math.min(100,breath));
        bar.style.width=breath+"%";

        if(breath<=0){
            clearInterval(loop);
            clearInterval(leavesInterval);
            render("<h2>사망</h2><p>숨이 새어 나갔다.</p>");
        }

        if(survived>=60){
            clearInterval(loop);
            clearInterval(leavesInterval);
            render("<h2>히든 엔딩</h2><p>멀리서 사이렌이 울린다.</p>");
        }
    },200);
}
</script>
</body>
</html>
