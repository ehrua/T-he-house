<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>히든 엔딩 - 쉬움</title>
<style>
body{background:#000;color:#eee;font-family:"Noto Serif KR",serif;}
#game{max-width:700px;margin:40px auto;}
button{
width:100%;padding:14px;margin-top:10px;
background:#111;color:#eee;border:1px solid #444;cursor:pointer;
}
.bar{width:100%;height:20px;background:#222;margin-top:15px;}
.fill{height:100%;background:#aaa;width:100%;transition:width .2s linear;}
p{line-height:1.7;}
</style>
</head>

<body>
<div id="game"></div>

<script>
/* ===== 사운드 ===== */
const bgm=new Audio("./sound/Symmetry.mp3");   // ✅ 메인 BGM 변경
const phoneSfx=new Audio("./sound/phone.mp3");
const leavesSfx=new Audio("./sound/fallenleaves.mp3");

bgm.loop=true;
bgm.volume=0.25;

/* ===== 상태 ===== */
const game=document.getElementById("game");
let holding=false;
let breath=100;
let survived=0;

let leavesPlaying=false;
let leavesStart=0;
let leavesInterval=null;

/* ===== 렌더 ===== */
function render(html){ game.innerHTML=html; }

/* ===== 시작 ===== */
render(`
<h2>공중전화</h2>
<p>수화기를 들었다.</p>
<button id="call">112를 누른다</button>
`);

document.getElementById("call").onclick=()=>{
bgm.play().catch(()=>{});
phoneSfx.play();
render("<p>뚜…</p>");
setTimeout(()=>{ phoneSfx.pause(); policeCall(); },3000);
};

/* ===== 통화 ===== */
function policeCall(){
render(`
<p>경찰: 태현씨죠?</p>
<p>태현: 네? 어떻게 제 이름을…</p>
<p>경찰?: 공중전화 앞 돌 뒤에 숨어 계세요.</p>
<p>경찰?: 낙엽 소리 조심하세요.</p>
<button id="hide">돌 뒤에 숨는다</button>
`);
document.getElementById("hide").onclick=startMiniGame;
}

/* ===== 미니게임 ===== */
function startMiniGame(){
breath=100; survived=0; holding=false;

render(`
<h2>돌 뒤</h2>
<p>낙엽 소리가 날 때 입을 막아라.</p>
<div class="bar"><div class="fill" id="bar"></div></div>
<button id="hold">입 막기</button>
`);

const btn=document.getElementById("hold");
btn.onmousedown=()=>holding=true;
btn.onmouseup=btn.onmouseleave=()=>holding=false;

/* 낙엽 */
leavesInterval=setInterval(()=>{
if(leavesPlaying) return;

leavesPlaying=true;
leavesStart=Date.now();
leavesSfx.currentTime=0;
leavesSfx.play();

bgm.volume=0.1;

setTimeout(()=>{
leavesSfx.pause();
leavesPlaying=false;
bgm.volume=0.25;
},3000+Math.random()*2000);

},10000);

gameLoop();
}

/* ===== 게임 루프 ===== */
function gameLoop(){
const bar=document.getElementById("bar");

const loop=setInterval(()=>{

/* 낙엽 판정 */
if(leavesPlaying && !holding){
const elapsed=Date.now()-leavesStart;
if(elapsed>1500){
clearAll(loop);
render("<h2>사망</h2><p>낙엽을 밟았다.</p>");
return;
}
}

/* 숨 */
if(holding){
breath-=1.2;
survived++;
}else{
breath+=2;
}

breath=Math.max(0,Math.min(100,breath));
bar.style.width=breath+"%";

if(breath<=0){
clearAll(loop);
render("<h2>사망</h2><p>숨이 새어 나갔다.</p>");
}

if(survived>=60){
clearAll(loop);
hiddenDialogue();   // ✅ 바로 엔딩 대신 대화 연출
}
},200);
}

/* ===== 히든 엔딩 대화 ===== */
function hiddenDialogue(){
bgm.volume=0.15;

const lines=[
"…",
"멀리서 사이렌 소리가 들린다.",
"경찰 무전음: 현장 도착까지 30초.",
"발소리가 멈췄다.",
"태현: …살았어."
"사실 그들은 한패였다."
"나는 그날일 이후 저주받은 블로그를 만들어야 한다."
];

render("<h2>히든 엔딩(한패)</h2>");
let i=0;

const talk=setInterval(()=>{
const p=document.createElement("p");
p.innerText=lines[i];
game.appendChild(p);
i++;

if(i>=lines.length){
clearInterval(talk);
}
},1300);
}

function clearAll(loop){
clearInterval(loop);
clearInterval(leavesInterval);
leavesSfx.pause();
}
</script>
</body>
</html>
