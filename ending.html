<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>히든 엔딩</title>
<style>
body{
    background:#000;
    color:#eee;
    font-family:"Noto Serif KR",serif;
}
#game{
    max-width:700px;
    margin:40px auto;
}
button{
    width:100%;
    padding:14px;
    margin-top:10px;
    background:#111;
    color:#eee;
    border:1px solid #444;
    cursor:pointer;
}
button:active{
    background:#333;
}
.bar{
    width:100%;
    height:20px;
    background:#222;
    margin-top:15px;
}
.fill{
    height:100%;
    background:#aaa;
    width:100%;
    transition:width 0.2s linear;
}
p{line-height:1.7;}
</style>
</head>

<body>
<div id="game"></div>

<script>
/* ===== 사운드 ===== */
const bgm = new Audio("./sound/TheDread.mp3");
const phoneSfx = new Audio("./sound/phone.mp3");
const leavesSfx = new Audio("./sound/fallenleaves.mp3");

bgm.loop = true;
bgm.volume = 0.25;

/* ===== 상태 ===== */
let holding = false;
let breath = 100;
let survived = 0;
let leavesTimer = null;
let leavesPlaying = false;

/* ===== 렌더 ===== */
const game = document.getElementById("game");
function render(html){
    game.innerHTML = html;
}

/* ===== 시작 ===== */
render(`
<h2>공중전화</h2>
<p>수화기를 들었다.</p>
<button id="call112">112를 누른다</button>
`);

document.getElementById("call112").onclick = () => {
    bgm.play().catch(()=>{});
    phoneSfx.currentTime = 0;
    phoneSfx.play();

    setTimeout(()=>{
        phoneSfx.pause();
        phoneSfx.currentTime = 0;
        policeCall();
    },3000);
};

/* ===== 경찰 통화 ===== */
function policeCall(){
    render(`
<p>뚜…</p>
<p><b>경찰:</b> 태현씨죠?</p>
<p><b>태현:</b> 네? 어떻게 제 이름을…</p>
<p><b>경찰?:</b> 지금 사건 장소 특정했고 지금 당장 출발하겠습니다.</p>
<p><b>경찰?:</b> 10분 정도 예상되네요.</p>
<p><b>경찰?:</b> 공중전화 부스 앞쪽에 있는 돌 뒤에 숨어 계세요.</p>
<p><b>경찰?:</b> 아, 그리고… 낙엽 밟는 소리 조심하세요.</p>
<p><b>태현:</b> 네? …</p>
<p><i>뚝—</i></p>
<button id="hide">돌 뒤에 숨는다</button>
`);

    document.getElementById("hide").onclick = startMiniGame;
}

/* ===== 숨참기 미니게임 ===== */
function startMiniGame(){
    breath = 100;
    survived = 0;

    render(`
<h2>돌 뒤</h2>
<p>숨을 죽여야 한다. 소리가 나면 끝이다.</p>

<div class="bar">
    <div class="fill" id="breathBar"></div>
</div>

<button id="holdBtn">숨 참기</button>
`);

    const btn = document.getElementById("holdBtn");

    btn.onmousedown = ()=>holding=true;
    btn.onmouseup = ()=>holding=false;
    btn.onmouseleave = ()=>holding=false;
    btn.ontouchstart = (e)=>{ e.preventDefault(); holding=true; };
    btn.ontouchend = ()=>holding=false;

    /* ===== 발소리 로직 ===== */
    leavesTimer = setInterval(()=>{
        if(leavesPlaying) return;

        leavesPlaying = true;
        leavesSfx.volume = Math.random() < 0.2 ? 1.0 : 0.6;
        leavesSfx.currentTime = 0;
        leavesSfx.play();

        const duration = 3000 + Math.random()*2000; // 3~5초

        setTimeout(()=>{
            leavesSfx.pause();
            leavesSfx.currentTime = 0;
            leavesPlaying = false;
        }, duration);

    }, 10000); // 10초마다

    gameLoop();
}

/* ===== 게임 루프 ===== */
function gameLoop(){
    const bar = document.getElementById("breathBar");

    const loop = setInterval(()=>{
        if(holding){
            breath -= 2;
            survived += 1;
        }else{
            breath += 1;
        }

        breath = Math.max(0,Math.min(100,breath));
        bar.style.width = breath + "%";

        if(breath <= 0){
            clearAll(loop);
            render("<h2>사망</h2><p>숨을 참지 못했다.</p>");
        }

        if(survived >= 60){
            clearAll(loop);
            render("<h2>히든 엔딩</h2><p>멀리서 사이렌 소리가 들린다.</p>");
        }
    },200);
}

/* ===== 정리 ===== */
function clearAll(loop){
    clearInterval(loop);
    clearInterval(leavesTimer);
    leavesSfx.pause();
}
</script>
</body>
</html>
